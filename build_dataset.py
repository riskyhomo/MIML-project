# -*- coding: utf-8 -*-
"""build_dataset.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1yXc-xBSjoDx6ViKLTQHJkq29ZC8BuZt3
"""

import numpy as np
import pandas as pd
import glob
import re
from sklearn.metrics import r2_score

# Limit for elastic region (first 0.5% strain)
ELASTIC_LIMIT = 0.005

results = []

print("\n=============== BUILDING DATASET ===============\n")

# Loop over all stress-strain files automatically
for file in glob.glob("stress_strain_*.dat"):
    print(f"Processing: {file}")

    # extract temp, strain_rate, direction, boxsize from filename
    match = re.findall(r"stress_strain_([0-9]+)_([0-9\.e-]+)_([xyz])_([0-9]+)", file)
    if not match:
        print("⚠ Skipped file (invalid name format)")
        continue

    temp, sr, direction, boxsize = match[0]
    temp = int(temp)
    sr = float(sr)
    boxsize = int(boxsize)

    try:
        # read data
        data = np.loadtxt(file)
        strain = data[:, 0]
        stress_raw = data[:, 1]

        # convert stress from bar → GPa
        stress = stress_raw * 0.0001

        # select elastic region
        mask = strain < ELASTIC_LIMIT
        x = strain[mask]
        y = stress[mask]

        # ensure enough data points
        if len(x) < 3:
            print("⚠ Not enough linear data points, skipping")
            continue

        # linear regression
        coeffs = np.polyfit(x, y, 1)
        y_pred = np.polyval(coeffs, x)

        young_modulus = coeffs[0]        # slope → E (GPa)
        r2 = r2_score(y, y_pred)

        # save result
        results.append([temp, sr, direction, boxsize, young_modulus, r2])

    except Exception as e:
        print("❌ Error reading file:", e)
        continue

# Build dataframe
df = pd.DataFrame(results, columns=["Temperature", "StrainRate", "Direction", "BoxSize", "YoungsModulus_GPa", "R2"])
df.to_csv("Final_Dataset.csv", index=False)

print("\n=============== DONE ===============")
print("Dataset saved → Final_Dataset.csv\n")
print(df)